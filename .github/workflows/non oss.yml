name: Build Kernel Marble (Manual SukiSU Fix)

on:
  workflow_dispatch:
    inputs:
      kernel_branch:
        description: 'Branch Kernel EvoX'
        required: true
        default: 'bka'
        type: string
      
      custom_version:
        description: 'Nama Versi'
        required: true
        default: '-Meng.Kernel-wsksu'
        type: string

jobs:
  build-manual-fix:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
    - name: Setup Swap Space (12GB)
      run: |
        echo "Creating Swap..."
        sudo fallocate -l 12G /swapfile
        sudo chmod 600 /swapfile
        sudo mkswap /swapfile
        sudo swapon /swapfile
        free -h

    - name: Checkout Kernel (EvoX Official)
      uses: actions/checkout@v4
      with:
        repository: Evolution-X-Devices/kernel_xiaomi_sm8450
        ref: ${{ github.event.inputs.kernel_branch }}
        fetch-depth: 1
        path: kernel_source

    - name: Setup Build Environment
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential bc bison flex libssl-dev libncurses-dev libncurses5-dev \
        git curl libelf-dev libfl-dev python3 python-is-python3 patch \
        gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi device-tree-compiler wget binutils-aarch64-linux-gnu zip

    - name: Download Greenforce Clang
      run: |
        bash <(wget -qO- https://raw.githubusercontent.com/greenforce-project/greenforce_clang/refs/heads/main/get_clang.sh)

    - name: Preventive Fixes 
      run: |
        cd kernel_source
        sed -i 's/probe_kernel_read/copy_from_kernel_nofault/g' include/linux/bpf.h || true
        sed -i 's/probe_kernel_read/copy_from_kernel_nofault/g' kernel/trace/bpf_trace.c || true
        sed -i 's/u64 clidr;/u64 clidr = 0;/g' arch/arm64/kvm/sys_regs.c || true
        grep -rl "clidr_e11" arch/arm64 | xargs sed -i 's/clidr_e11/clidr_el1/g' || true
        # Fix Haptics
        sed -i 's/const char \*name;/const char *name = NULL;/g' drivers/input/misc/qcom-hv-haptics.c || true

    - name: Setup SukiSU (MANUAL INTEGRATION)
      run: |
        cd kernel_source
        
        echo "--> Cloning SukiSU Repository..."
        # Clone langsung ke root kernel source
        git clone --depth=1 https://github.com/SukiSU-Ultra/SukiSU-Ultra KernelSU
        
        echo "--> Creating Symlink..."
        # Kita buat symlink manual. Ini jauh lebih akurat daripada script otomatis.
        # Kita arahkan folder 'kernel' milik SukiSU ke 'drivers/kernelsu'
        cd drivers
        ln -sf ../KernelSU/kernel kernelsu
        cd ..
        
        echo "--> Patching Drivers Makefile..."
        # Tambahkan ke Makefile agar dicompile
        # Kita pakai append (>>) agar aman
        if ! grep -q "kernelsu" drivers/Makefile; then
            echo 'obj-$(CONFIG_KSU) += kernelsu/' >> drivers/Makefile
        fi
        
        echo "--> Patching Drivers Kconfig..."
        # Tambahkan ke Kconfig agar muncul di menu config
        if ! grep -q "drivers/kernelsu/Kconfig" drivers/Kconfig; then
            sed -i '$d' drivers/Kconfig
            echo 'source "drivers/kernelsu/Kconfig"' >> drivers/Kconfig
            echo 'endmenu' >> drivers/Kconfig
        fi
        
        echo "✅ SukiSU Manual Setup Complete!"

    - name: Configure Kernel
      run: |
        cd kernel_source
        export PATH="$GITHUB_WORKSPACE/greenforce-clang/bin:$PATH"
        
        ARGS="O=out ARCH=arm64 \
        CC=clang \
        LLVM=1 \
        LLVM_IAS=1 \
        CROSS_COMPILE=aarch64-linux-gnu- \
        CROSS_COMPILE_COMPAT=arm-linux-gnueabi- \
        AR=llvm-ar \
        NM=llvm-nm \
        OBJCOPY=llvm-objcopy \
        OBJDUMP=llvm-objdump \
        STRIP=llvm-strip"

        MY_CFLAGS="-Wno-uninitialized-const-pointer -Wno-sometimes-uninitialized"
        
        make $ARGS mrproper
        make $ARGS KCFLAGS="$MY_CFLAGS" gki_defconfig
        
        # Merge Config
        ./scripts/kconfig/merge_config.sh -m -O out out/.config \
            arch/arm64/configs/vendor/waipio_GKI.config \
            arch/arm64/configs/vendor/xiaomi_GKI.config \
            arch/arm64/configs/vendor/debugfs.config \
            arch/arm64/configs/vendor/marble_GKI.config
            
        ./scripts/config --file out/.config --set-str LOCALVERSION "${{ github.event.inputs.custom_version }}"
        
        # [CRITICAL] Enable Dependencies for KPROBES & KSU
        # Ini yang sering bikin config KSU hilang sendiri!
        ./scripts/config --file out/.config --enable CONFIG_KALLSYMS
        ./scripts/config --file out/.config --enable CONFIG_KALLSYMS_ALL
        ./scripts/config --file out/.config --enable CONFIG_KPROBES
        ./scripts/config --file out/.config --enable CONFIG_KRETPROBES
        ./scripts/config --file out/.config --enable CONFIG_HAVE_SYSCALL_TRACEPOINTS
        ./scripts/config --file out/.config --enable CONFIG_KSU_SYSCALL_HOOK

        # Anti-Bootloop Settings
        ./scripts/config --file out/.config --enable CONFIG_MODULES
        ./scripts/config --file out/.config --disable CONFIG_MODVERSIONS
        ./scripts/config --file out/.config --disable CONFIG_MODULE_SIG
        ./scripts/config --file out/.config --enable CONFIG_MODULE_FORCE_LOAD
        
        # Force SukiSU as Module (LKM)
        ./scripts/config --file out/.config --set-str CONFIG_KSU m
        
        make $ARGS KCFLAGS="$MY_CFLAGS" olddefconfig
        
        echo "=== VERIFIKASI AKHIR CONFIG ==="
        # Jika grep ini gagal, kita hentikan proses biar gak buang waktu
        if grep -q "CONFIG_KSU=m" out/.config; then
            echo "✅ CONFIG_KSU is set to Module (m). Aman."
        else
            echo "❌ ERROR FATAL: CONFIG_KSU hilang dari .config! Cek dependencies."
            # Kita exit kalau config gagal, biar ketauan langsung
            exit 1
        fi

    - name: Build Kernel & Modules
      run: |
        cd kernel_source
        export PATH="$GITHUB_WORKSPACE/greenforce-clang/bin:$PATH"
        
        ARGS="O=out ARCH=arm64 \
        CC=clang \
        LLVM=1 \
        LLVM_IAS=1 \
        CROSS_COMPILE=aarch64-linux-gnu- \
        CROSS_COMPILE_COMPAT=arm-linux-gnueabi- \
        AR=llvm-ar \
        NM=llvm-nm \
        OBJCOPY=llvm-objcopy \
        OBJDUMP=llvm-objdump \
        STRIP=llvm-strip"
        
        MY_CFLAGS="-Wno-uninitialized-const-pointer -Wno-sometimes-uninitialized"
        
        echo "Building Image & SukiSU..."
        make $ARGS KCFLAGS="$MY_CFLAGS" -j$(nproc --all) Image modules
        
        gzip -c out/arch/arm64/boot/Image > out/arch/arm64/boot/Image.gz

    - name: Collect Artifacts
      run: |
        cd kernel_source/out
        
        mkdir -p final_artifacts/modules
        
        # Ambil Image
        cp arch/arm64/boot/Image.gz final_artifacts/
        
        echo "Looking for SukiSU module..."
        # Cari di seluruh folder drivers di dalam out
        find drivers -name "sukisu.ko" -exec cp {} final_artifacts/modules/ \; || true
        find drivers -name "ksu.ko" -exec cp {} final_artifacts/modules/ \; || true
        find drivers -name "kernelsu.ko" -exec cp {} final_artifacts/modules/ \; || true
        
        # Cek apakah module berhasil dicopy
        if [ -z "$(ls -A final_artifacts/modules)" ]; then
           echo "❌ ERROR: Module SukiSU tidak ditemukan!"
           echo "Daftar file di out/drivers/kernelsu (Debug):"
           ls -R drivers/kernelsu || true
           exit 1
        else
           echo "✅ Module SukiSU ditemukan."
           ls -l final_artifacts/modules/
        fi
        
        # Zip Module SukiSU
        cd final_artifacts/modules
        zip -r ../SukiSU_Module.zip .

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: EvoX-ManualSukiSU-Build
        path: kernel_source/out/final_artifacts/
