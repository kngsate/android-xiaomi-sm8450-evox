name: Build Kernel Marble (Nekoshirro PURE - Battery Saver)

on:
  workflow_dispatch:
    inputs:
      kernel_branch:
        description: 'Branch Kernel (Default: 15)'
        required: true
        default: 'sukisu'
        type: string
      
      custom_version:
        description: 'Nama Versi'
        required: true
        default: '-Neko-Pure-Battery'
        type: string

jobs:
  build-neko-pure:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
    - name: Setup Swap Space (12GB)
      run: |
        echo "Creating Swap..."
        sudo fallocate -l 12G /swapfile
        sudo chmod 600 /swapfile
        sudo mkswap /swapfile
        sudo swapon /swapfile
        free -h

    - name: Checkout Kernel (Nekoshirro Source)
      uses: actions/checkout@v4
      with:
        repository: nekoshirro/platform_kernel_xiaomi_sm8450
        ref: ${{ github.event.inputs.kernel_branch }}
        fetch-depth: 1
        path: kernel_source

    - name: Setup Build Environment
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential bc bison flex libssl-dev libncurses-dev libncurses5-dev \
        git curl libelf-dev libfl-dev python3 python-is-python3 patch \
        gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi device-tree-compiler wget binutils-aarch64-linux-gnu zip

    - name: Download Greenforce Clang
      run: |
        bash <(wget -qO- https://raw.githubusercontent.com/greenforce-project/greenforce_clang/refs/heads/main/get_clang.sh)

    - name: Preventive Fixes 
      run: |
        cd kernel_source
        # Fix standar Clang agar compile lancar
        sed -i 's/probe_kernel_read/copy_from_kernel_nofault/g' include/linux/bpf.h || true
        sed -i 's/probe_kernel_read/copy_from_kernel_nofault/g' kernel/trace/bpf_trace.c || true
        sed -i 's/u64 clidr;/u64 clidr = 0;/g' arch/arm64/kvm/sys_regs.c || true
        grep -rl "clidr_e11" arch/arm64 | xargs sed -i 's/clidr_e11/clidr_el1/g' || true
        # Fix Haptics (Wajib)
        sed -i 's/const char \*name;/const char *name = NULL;/g' drivers/input/misc/qcom-hv-haptics.c || true

    # STEP SUKISU DIHAPUS TOTAL

    - name: Configure Kernel
      run: |
        cd kernel_source
        export PATH="$GITHUB_WORKSPACE/greenforce-clang/bin:$PATH"
        
        ARGS="O=out ARCH=arm64 \
        CC=clang \
        LLVM=1 \
        LLVM_IAS=1 \
        CROSS_COMPILE=aarch64-linux-gnu- \
        CROSS_COMPILE_COMPAT=arm-linux-gnueabi- \
        AR=llvm-ar \
        NM=llvm-nm \
        OBJCOPY=llvm-objcopy \
        OBJDUMP=llvm-objdump \
        STRIP=llvm-strip"

        # [FLAGS BATTERY SAVER]
        MY_CFLAGS="-Wno-uninitialized-const-pointer -Wno-sometimes-uninitialized -Os -flto=thin -mcpu=cortex-a55 -fno-unroll-loops"
        
        # Bersihkan sisa config lama
        make $ARGS mrproper
        make $ARGS KCFLAGS="$MY_CFLAGS" gki_defconfig
        
        # Merge Config Vendor
        ./scripts/kconfig/merge_config.sh -m -O out out/.config \
            arch/arm64/configs/vendor/waipio_GKI.config \
            arch/arm64/configs/vendor/xiaomi_GKI.config \
            arch/arm64/configs/vendor/debugfs.config \
            arch/arm64/configs/vendor/marble_GKI.config
            
        ./scripts/config --file out/.config --set-str LOCALVERSION "${{ github.event.inputs.custom_version }}"

        # [ANTI BOOTLOOP - PENTING]
        # Mematikan validasi module agar kernel ini mau meload driver bawaan ROM EvoX
        ./scripts/config --file out/.config --enable CONFIG_MODULES
        ./scripts/config --file out/.config --disable CONFIG_MODVERSIONS
        ./scripts/config --file out/.config --disable CONFIG_MODULE_SIG
        ./scripts/config --file out/.config --enable CONFIG_MODULE_FORCE_LOAD
        
        make $ARGS KCFLAGS="$MY_CFLAGS" olddefconfig

    - name: Build Kernel Image
      run: |
        cd kernel_source
        export PATH="$GITHUB_WORKSPACE/greenforce-clang/bin:$PATH"
        
        ARGS="O=out ARCH=arm64 \
        CC=clang \
        LLVM=1 \
        LLVM_IAS=1 \
        CROSS_COMPILE=aarch64-linux-gnu- \
        CROSS_COMPILE_COMPAT=arm-linux-gnueabi- \
        AR=llvm-ar \
        NM=llvm-nm \
        OBJCOPY=llvm-objcopy \
        OBJDUMP=llvm-objdump \
        STRIP=llvm-strip"
        
        # Flags Battery
        MY_CFLAGS="-Wno-uninitialized-const-pointer -Wno-sometimes-uninitialized -Os -flto=thin -mcpu=cortex-a55 -fno-unroll-loops"
        
        echo "Building Image (Pure Battery Saver)..."
        make $ARGS KCFLAGS="$MY_CFLAGS" -j$(nproc --all) Image
        
        gzip -c out/arch/arm64/boot/Image > out/arch/arm64/boot/Image.gz

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Neko-Pure-BatterySaver
        path: kernel_source/out/arch/arm64/boot/Image.gz
